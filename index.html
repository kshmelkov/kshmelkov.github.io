<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <title>Konstantin Shmelkov&#39;s blog by kshmelkov</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Konstantin Shmelkov&#39;s blog</h1>
        <h2>My online life</h2>

        <section id="downloads">
          <a href="https://github.com/kshmelkov" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1>
<a id="archlinux-installation-on-luks-encrypted-btrfs-partition-booting-by-uefi" class="anchor" href="#archlinux-installation-on-luks-encrypted-btrfs-partition-booting-by-uefi" aria-hidden="true"><span class="octicon octicon-link"></span></a>ArchLinux installation on LUKS-encrypted Btrfs partition booting by UEFI</h1>

<p>Recently I have upgraded my system to Lenovo ThinkPad X1 Carbon Gen2 laptop. I
decided to install quiet complicated setup: ArchLinux on Btrfs with full drive
encryption (LUKS) and UEFI boot from USB key with /boot and LUKS header.</p>

<p>It allows to have deniable encryption (LUKS header on USB key, laptop's
SSD is entirely encrypted), two-factor authorization (you can't load without
LUKS header which is encrypted with your password). UEFI boot is just for fun.
I highly recommend to read all <a href="https://wiki.archlinux.org/index.php/Dm-crypt">ArchWiki pages</a> about full disk encryption to
understand different stages of installation.</p>

<p>I have choosed Btrfs because it is a modern, fast filesystem and has some cool
features like snapshots and dynamic subvolumes. It can also manage its
partitions (subvolumes) without partition table. As we put /boot on USB key,
we can give entire SSD for Btrfs (no swap support though). Another important
question is TRIM/discard support. In this setting it is totally possible, but
it is considered <a href="http://asalor.blogspot.fr/2011/08/trim-dm-crypt-problems.html">insecure</a>. It is up to you to decide.</p>

<p>I have read lots of wiki pages and forums to figure out the installation
process. So I want to explain it step-by-step for other people.</p>

<p>As USB key I have chosed <a href="http://www.integralmemory.com/product/fusion-usb-3-superspeed-small-metal-flash-drive">Integral Fusion USB 3.0</a>. It has rather good
read speed, but awful write speed (not important for me). It is also very
small and has no cap.</p>

<p><strong>DISCLAIMER</strong>: You do everything described on your own risk. By the way, you will <em>destroy</em> all the data present on you laptop. I hope you understand it. If it isn't clear, please re-read ArchWiki.</p>

<hr>

<p>First of all, don't forget to update your BIOS version. It can be done from
Windows slightly easier. You need another USB key to write down ArchLinux
installation image. Then go to BIOS and set the boot mode as UEFI first. Boot
from this USB in UEFI mode. On X1 Carbon you should press F12 after powering
on to choose USB device to boot from.</p>

<p>If you have a laptop with HiDPI you will be surprised with such a small font.
Fix it with command:</p>

<pre><code>setfont sun12x22
</code></pre>

<p>It becomes a bit better. Actually it is the largest console font available.
Then check that you are in UEFI mode:</p>

<pre><code>efivar -l
</code></pre>

<p>If you get an error, go again to BIOS. Now you need to connect to the
Internet. I connect via WiFi so:</p>

<pre><code>wifi-menu
</code></pre>

<p>Double check that you have an Internet access. First of all, wipe the disk. I
amn't sure if it really necessary with the SSD, but it is widely recommended
(especially for deniable security). To fill a disk with pseudo-random data you
can use <code>/dev/urandom</code> (it is too slow) or open the whole disk as an encrypted
volume and write zeros inside. The sequence of zeros will be encrypted in very
messy data. If you are really serious about deniable security, choose the same
cipher that you want to use later. I need to put an usual disclaimer that next
actions are irreversible, you destroy all data on <code>/dev/sdX</code> (it is your SSD by
the way).</p>

<pre><code>cryptsetup open --type plain /dev/sdX ssd
</code></pre>

<p>Enter anything as password. </p>

<pre><code>ddrescue -f /dev/zero /dev/mapper/ssd
</code></pre>

<p>It'll take a while. Hopefully SSD is fast, for me it was a bit less than 10 min.</p>

<pre><code>cryptsetup close ssd
</code></pre>

<p>Now initialization of bootable USB key. I will denote it as <code>/dev/sdY</code>.</p>

<pre><code>gdisk /dev/sdY
</code></pre>

<p>Create new GPT partition table and small partition for /boot (about 300-500Mb).
Define its type as EF00 (in gdisk EFI System Partition). Exit from gdisk and
format it in FAT32:</p>

<pre><code>mkfs.fat -F32 /dev/sdY1
mkdir /efi
mount /dev/sdY1 /efi
cd /efi
</code></pre>

<p>Next create an empty file for LUKS header (you might modify header size if you choose other encryption settings):</p>

<pre><code>truncate -s 2M header.img
</code></pre>

<p>Create device-mapping encrypted device with this header. Before choosing a
cipher, you can test the speed of your system with </p>

<pre><code>cryptsetup benchmark
</code></pre>

<p>If you choose XTS mode, remember that effective key size is divided by two.
Let's create an encrypted device:</p>

<pre><code>cryptsetup --cipher=aes-xts-plain64 --hash=sha512 --verify-passphrase --key-size=256 luksFormat /dev/sdX --header header.img
cryptsetup open --header header.img --type luks /dev/sdX root
</code></pre>

<p>Next create the filesystem and mount it. If you decide to enable TRIM, add
discard to mount options:</p>

<pre><code>mkfs.btrfs -L "ARCHROOT" /dev/mapper/root
mount -o defaults,noatime,ssd /dev/mapper/root /mnt/btrfs-root
btrfs subvolume create /mnt/btrfs-root/__active
btrfs subvolume create /mnt/btrfs-root/__active/home
btrfs subvolume create /mnt/btrfs-root/__active/var
</code></pre>

<p>You can add some other subvolumes if you want.</p>

<pre><code>mount -o subvol=__active /dev/mapper/root /mnt
</code></pre>

<p>Change default permissions (700):
    chmod 755 /mnt/btrfs-root/__active
    chmod 755 /mnt/btrfs-root/__active/home
    chmod 755 /mnt/btrfs-root/__active/var</p>

<p>Before chrooting remount USB key:</p>

<pre><code>umount /efi
mkdir /mnt/boot
mount /dev/sdY1 /mnt/boot
</code></pre>

<p>Now you can proceed with ordinary install, you can
consult <a href="https://wiki.archlinux.org/index.php/installation_guide">ArchWiki installation guide</a>:</p>

<pre><code>nano /etc/pacman.d/mirrorlist
pacstrap /mnt base base-devel wpa_supplicant gummiboot
genfstab -U -p /mnt &gt;&gt; /mnt/etc/fstab
</code></pre>

<p>Later you can add <code>noauto</code> option in <code>fstab</code> for <code>/boot</code> partition. Nevertheless, it
must be mounted to update the kernel. Now we are ready to go inside!</p>

<pre><code>arch-chroot /mnt /bin/bash
nano /etc/locale.gen
</code></pre>

<p>Uncomment your favorite locale, for example, en_US.UTF-8 UTF-8.</p>

<pre><code>locale-gen
echo LANG=en_CA.UTF-8 &gt; /etc/locale.conf
export LANG=en_US.UTF-8
</code></pre>

<p>Choose your timezone</p>

<pre><code>ls /usr/share/zoneinfo/
ln -s /usr/share/zoneinfo/&lt;continent&gt;/&lt;city&gt; /etc/localtime
hwclock --systohc --utc
</code></pre>

<p>In the next file you should enter </p>

<pre><code>FONT=sun12x22
KEYMAP=us
</code></pre>

<p>or another keymap in which you have password:</p>

<pre><code>nano /etc/vconsole.conf
</code></pre>

<p>Store the desired network name:</p>

<pre><code>nano /etc/hostname
</code></pre>

<p>You could make a <code>netctl</code> profile for the first boot.
Then set root password:</p>

<pre><code>passwd
</code></pre>

<p>Now it is an important moment. You need to set up 
initcpio hooks to successfully unlock the disk.
Unfortunately, default encrypt hook doesn't yet support 
remote LUKS header, so you need to modify it.</p>

<pre><code>nano /etc/mkinitcpio.conf
</code></pre>

<p>Remove <code>fsck</code> hook, insert </p>

<pre><code>keyboard keymap consolefont encrypt2 
</code></pre>

<p>just before <code>filesystems</code> hook (keyboard exists normally, but
you should move it before <code>encrypt2</code>). Add also</p>

<pre><code>MODULES="loop"
FILES="/boot/header.img"
</code></pre>

<p>I added also in MODULES i915 to enable early KMS on my laptop.
Create encrypt2 hook as described in <a href="https://wiki.archlinux.org/index.php/Dm-crypt/Specialties#Encrypted_system_using_a_remote_LUKS_header">ArchWiki</a></p>

<pre><code>cp /lib/initcpio/hooks/encrypt{,2}
cp /usr/lib/initcpio/install/encrypt{,2}
nano /lib/initcpio/hooks/encrypt2
</code></pre>

<p>Now you are ready to regenerate initramfs image:</p>

<pre><code>mkinitcpio -p linux
</code></pre>

<p>It is time to install bootloader. I decided to use gummiboot
because it is purely UEFI, simple, text-based. You could use GRUB2
or rEFInd:</p>

<pre><code>gummiboot install
</code></pre>

<p>Insert following files. If you don't want menu,
insert timeout 0. In this case you can summon it if you
press space while loading.</p>

<h2>
<a id="bootloaderloaderconf" class="anchor" href="#bootloaderloaderconf" aria-hidden="true"><span class="octicon octicon-link"></span></a>/boot/loader/loader.conf</h2>

<p>default  arch
   timeout  3</p>

<h2>
<a id="bootloaderentriesarchconf" class="anchor" href="#bootloaderentriesarchconf" aria-hidden="true"><span class="octicon octicon-link"></span></a>/boot/loader/entries/arch.conf</h2>

<p>title Arch Linux
   linux /vmlinuz-linux
   initrd /initramfs-linux.img
   options cryptdevice=/dev/sdX:root:header root=/dev/mapper/root rootflags=subvol=__active rw
Add <code>,allow-discards</code> after header option if you decided to go with TRIM/discard support. </p>

<p>Hope that it works. It is time to try!</p>

<pre><code>exit
umount /mnt/boot
umount /mnt
cryptsetup close root
reboot
</code></pre>
      </section>
    </div>

    
  </body>
</html>